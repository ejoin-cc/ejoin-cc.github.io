---
title: DDNS
---
# DDNS

## 前言

假如我们现在使用一台本地服务器并部署了一些服务，如果我们想要随时随地访问到服务器上的服务，需要一些额外的配置。

要想外部访问到本地服务器，这个服务器需要有 IP 地址来作为唯一标识。而 IPv4 数目较少，一般家庭内部的设备不能直接获取公网 IPv4，如果想要运行商提供的话，会额外有一些费用。IPv6 地址范围很大，一般现在的路由器都支持设备获取公网 IPv6。我们可以将域名解析到服务器的公网 IPv6 上，这样就可以随时随地通过域名访问服务。而服务器上的 IPv6 地址经常会发生变化，如果手动配置域名的解析记录很麻烦，可以使用 DDNS 来完成自动修改域名解析的行为。

## 前提

1. 服务器具有 IPv6 公网地址（可以通过桥接光猫，路由器打开 IPv6 开关实现，注意如果需要外网访问的话，需要调整 IPv6 防火墙）。
2. 拥有一个域名（下面使用阿里云购买的域名，使用 Cloudflare 提供 DNS 解析）。

## 使用

### 接入 Cloudflare

首先注册登录 [Cloudflare](https://www.cloudflare-cn.com/) 账号，然后添加站点，输入购买的域名。Cloudflare 提供多种不同的订阅计划，当前使用免费的计划足以满足要求。此时系统可能会自动解析并导入现存的 DNS 记录，可以根据需要保留或删除。

信息填写提交完毕后，Cloudflare 会提供两个名称服务器的地址，需要在域名注册商位置进行修改（查询对应域名注册商的文档进行修改）。通常名称服务器的更改最多需要 24 小时才能完全生效，一旦生效，Cloudflare 会通过邮件进行通知。

收到邮件通知后，可以在 Cloudflare 上继续验证域名服务器。如果提供的网站服务使用 SSL 证书并启用 HTTPS，建议开启 HTTPS 重写，并在 SSL/TLS 设置中将模式设置为「完全」，如果设置为更高级别的模式会增加 SSL 的响应时间。

然后我们需要创建 [API 令牌](https://dash.cloudflare.com/profile/api-tokens)，点击创建后使用「编辑区域 DNS」的模板，「区域资源」调整为「账户的所有区域」。创建完令牌后把值暂时保存下来稍后需要使用。

### 部署 DDNS

> 阅读项目的官方文档了解更多细节：[Github 地址](https://github.com/jeessy2/ddns-go)

在目录下创建编辑 docker-compose.yml 文件：

``` yml
version: '3.9'
services:
  ddns-go:
    image: jeessy/ddns-go:latest
    container_name: ddns
    restart: always
    network_mode: "host"
    volumes:
      - ./data:/root
    ports:
      - 9876:9876
```

由于 ddns 需要读取宿主机的 IP 地址，为了方便这里直接使用 host 模式，此时 ports 没有什么意义，只是为了标记服务使用的端口。

然后执行 `docker-compose up -d` 启动服务，执行完成后，在内网浏览器打开 `http://[IP]:9876`，开始进行配置。

### 配置 DDNS

DDNS 的配置很简单直观，按照提示登录修改用户后可以按照如下描述进行配置：

1. 选择对应的 DNS 服务提供商（Cloudflare）。
2. 填写此前创建出来的 Cloudflare Token。
3. 启用拥有的公网 IP 类型（这里我选择 IPv6）。
4. Domains 中填写要解析的域名，可以写入多个域名，也可以填写通配域名（如 *.example.com 等）。
5. Webhook 部分选填，用于通知域名解析的更新结果（域名更新成功或不成功时, 会回调填写的URL）。
6. DDNS 的配置不需要频繁改动，将禁止外网访问勾选会更加安全。

更多的配置细节可以查看 DDNS 的官方文档。

可以在 Cloudflare 控制台上查看是否已经成功添加 DNS 解析记录。Cloudflare 的 DNS 记录中可以调整代理状态，如果开启代理，则会有 CDN 的效果，更加安全并且支持 IPv4 设备访问到纯 IPv6 的机器上，但是免费订阅的 CDN 节点都在国外，国内访问反而会更慢。如果仅 DNS 不使用代理的话，国内访问一般会更快，但是会暴露原始 IP，可以自己权衡下，按照不同的策略调整。

正确配置完之后就可以通过域名访问到服务器，但域名解析默认访问的是 80 和 443 端口，我们还需要其他服务来进行代理，才能正确通过域名访问到指定服务上，我们将在下一页描述 nginx proxy manager 的配置，它可以提供这项服务。